---
name: Test Coverage
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
      - name: Run tests with coverage
        run: make test-coverage
      - name: Check coverage threshold
        run: |
          # Extract coverage percentage from coverage.json
          COVERAGE=$(python -c "import json; print(json.load(open('coverage.json'))['totals']['percent_covered'])")
          echo "Current coverage: ${COVERAGE}%"

          # Set threshold (matches pyproject.toml default when uncommented)
          THRESHOLD=80

          # Compare coverage to threshold
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "âŒ Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            exit 1
          else
            echo "âœ… Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"
          fi
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            htmlcov/
            coverage.json
          retention-days: 30
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('coverage.json', 'utf8'));
            const percent = coverage.totals.percent_covered.toFixed(2);
            const missing = coverage.totals.missing_lines;
            const covered = coverage.totals.covered_lines;
            const total = covered + missing;

            const body = `### ðŸ“Š Test Coverage Report

            **Overall Coverage: ${percent}%**

            - âœ… Covered lines: ${covered}
            - âŒ Missing lines: ${missing}
            - ðŸ“ Total lines: ${total}

            <details>
            <summary>View detailed coverage report</summary>

            Download the \`coverage-report\` artifact from this workflow run to view the full HTML report.

            </details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
