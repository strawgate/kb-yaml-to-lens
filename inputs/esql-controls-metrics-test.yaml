---
dashboards:
  - name: '[ES|QL] Agent Metrics Test'
    description: Test dashboard for ES|QL controls using metrics-* index with agent fields

    settings:
      controls:
        chain_controls: true
        label_position: inline

    controls:
      # Control 1: Agent Name (query-driven)
      - type: esql_query
        variable_name: agent_name
        variable_type: values
        esql_query: FROM metrics-* | STATS count = COUNT(*) BY agent.name | SORT count DESC | KEEP agent.name | LIMIT 20
        title: Agent Name
        width: medium

      # Control 2: Agent ID (query-driven, filtered by agent name)
      - type: esql_query
        variable_name: agent_id
        variable_type: values
        esql_query: FROM metrics-* | WHERE agent.name IN (?agent_name) | STATS count = COUNT(*) BY agent.id | SORT count DESC | KEEP agent.id | LIMIT 20
        title: Agent ID
        width: medium

      # Control 3: Agent Version (query-driven, filtered by name and ID)
      - type: esql_query
        variable_name: agent_version
        variable_type: values
        esql_query: FROM metrics-* | WHERE agent.name IN (?agent_name) AND agent.id IN (?agent_id) | STATS count = COUNT(*) BY agent.version | SORT agent.version | KEEP agent.version | LIMIT 20
        title: Agent Version
        width: medium

    panels:
      # Panel 1: Total Events Metric
      - title: Total Agent Events
        description: Total number of events matching the selected filters
        grid: {x: 0, y: 0, w: 12, h: 8}
        esql:
          type: metric
          primary:
            field: total_events
            id: metric_total_events
          query:
            - FROM metrics-*
            - WHERE agent.name IN (?agent_name)
            - WHERE agent.id IN (?agent_id)
            - WHERE agent.version IN (?agent_version)
            - STATS total_events = COUNT(*)

      # Panel 2: Events by Agent Name (Pie)
      - title: Events by Agent Name
        description: Distribution of events across agent names
        grid: {x: 12, y: 0, w: 12, h: 8}
        esql:
          type: pie
          slice_by:
            - field: agent.name
              id: dim_agent_name
          metric:
            field: count
            id: metric_count
          query:
            - FROM metrics-*
            - WHERE agent.name IN (?agent_name)
            - WHERE agent.id IN (?agent_id)
            - WHERE agent.version IN (?agent_version)
            - STATS count = COUNT(*) BY agent.name
            - SORT count DESC
            - LIMIT 10

      # Panel 3: Events by Agent Version (Pie)
      - title: Events by Agent Version
        description: Distribution of events across agent versions
        grid: {x: 24, y: 0, w: 12, h: 8}
        esql:
          type: pie
          slice_by:
            - field: agent.version
              id: dim_agent_version
          metric:
            field: count
            id: metric_count
          query:
            - FROM metrics-*
            - WHERE agent.name IN (?agent_name)
            - WHERE agent.id IN (?agent_id)
            - WHERE agent.version IN (?agent_version)
            - STATS count = COUNT(*) BY agent.version
            - SORT count DESC
            - LIMIT 10

      # Panel 4: Agent Details Table
      - title: Agent Details
        description: Detailed breakdown of events by agent name, ID, and version
        grid: {x: 0, y: 8, w: 48, h: 12}
        esql:
          type: datatable
          query:
            - FROM metrics-*
            - WHERE agent.name IN (?agent_name)
            - WHERE agent.id IN (?agent_id)
            - WHERE agent.version IN (?agent_version)
            - STATS count = COUNT(*) BY agent.name, agent.id, agent.version
            - SORT count DESC
            - LIMIT 100
