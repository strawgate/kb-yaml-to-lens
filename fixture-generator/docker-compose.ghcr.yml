version: '3.8'

# Docker Compose configuration for Kibana Fixture Generator
#
# This configuration uses pre-built images from GitHub Container Registry (GHCR)
# to avoid long build times. Images are built by the CI workflow and cached.
#
# Usage:
#   # Use latest pre-built image from GHCR
#   docker-compose run generator
#
#   # Generate specific fixture
#   docker-compose run generator node examples/metric-basic.js
#
#   # Use specific Kibana version
#   KIBANA_VERSION=v9.3.0 docker-compose run generator
#
#   # Build locally (if GHCR image not available)
#   docker-compose --profile local-build build
#   docker-compose --profile local-build run generator

services:
  # Service using pre-built GHCR image (default)
  generator:
    image: ghcr.io/strawgate/kb-yaml-to-lens/kibana-fixture-generator:${KIBANA_VERSION:-main}
    pull_policy: always
    volumes:
      # Output JSON files
      - ./output:/tool/output
      # Mount examples directory for live editing
      - ./examples:/tool/examples:ro
    environment:
      - NODE_OPTIONS=--max_old_space_size=8192
      - OUTPUT_DIR=/tool/output
      - NODE_PATH=/kibana/node_modules
    mem_limit: 10g

  # Service for local builds (use with --profile local-build)
  generator-local:
    profiles:
      - local-build
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NODE_VERSION: 22.21.1
        KIBANA_VERSION: ${KIBANA_VERSION:-main}
    volumes:
      # Output JSON files
      - ./output:/tool/output
      # Mount examples directory for live editing
      - ./examples:/tool/examples:ro
      # Cache Kibana node_modules between runs
      - kibana_node_modules:/kibana/node_modules
      # Cache yarn cache
      - yarn_cache:/root/.cache/yarn
    environment:
      - NODE_OPTIONS=--max_old_space_size=8192
      - OUTPUT_DIR=/tool/output
      - NODE_PATH=/kibana/node_modules
    mem_limit: 10g

volumes:
  kibana_node_modules:
  yarn_cache:
