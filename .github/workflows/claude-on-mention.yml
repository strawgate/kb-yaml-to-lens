name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.title, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # Install UV package manager
      - name: Install UV
        uses: astral-sh/setup-uv@v7

      - name: Set triage prompt
        id: triage-prompt
        run: |
          cat >> $GITHUB_OUTPUT << 'EOF'
          PROMPT<<PROMPT_END
          You're a code assistant for kb-yaml-to-lens, a Python project that compiles Kibana dashboards from YAML to Lens format.

          # Getting Started
          1. Call the generate_agents_md tool to get a high-level summary of the project you're working in
          2. Get the ${{ github.event_name == 'issues' && 'issue' || 'pull request' }} ${{ github.event.issue.number || github.event.pull_request.number }} in the GitHub repository: ${{ github.repository }}.
          3. Don't forget about your MCP tools to call search_code, get_files, etc. to search the repository and other repositories to identify the related classes, methods, docs, tests, etc that are relevant to the code.
          4. Be Thorough! Go the extra mile! Do great work!
          5. If anything you needed or wanted to do during your work was not possible, document the problem in a `Problems Encountered` section
          of your response. Especially if it was something you were asked to do like research the web, run tests, lint, etc.

          # PR Review Interaction Tools
          You now have access to tools for interacting with pull request reviews:
          - **get_pr_review_threads**: Get all review threads (including CodeRabbit feedback) with their IDs and resolved status
          - **get_pr_review_comments**: Get all review comments with comment IDs for replying
          - **reply_to_review_comment**: Reply to any review comment (including CodeRabbit's) using the comment ID
          - **resolve_review_thread**: Mark a review conversation thread as resolved using the thread ID
          - **unresolve_review_thread**: Mark a review conversation thread as unresolved using the thread ID

          When responding to CodeRabbit or other review feedback:
          1. Use get_pr_review_comments or get_pr_review_threads to find the relevant comment/thread
          2. Use reply_to_review_comment to respond to specific feedback
          3. Use resolve_review_thread to mark conversations as resolved after addressing them

          PROMPT_END
          EOF

      - name: Setup GitHub MCP Server
        run: |
          # Install dependencies for the custom GitHub PR MCP server
          pip install fastmcp httpx
          
          mkdir -p /tmp/mcp-config
          cat > /tmp/mcp-config/mcp-servers.json << 'EOF'
          {
            "mcpServers": {
              "github-pr": {
                "type": "stdio",
                "command": "python",
                "args": ["scripts/github_pr_mcp_server.py"],
                "env": {
                  "GITHUB_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                }
              },
              "repository-summary": {
                "type": "http",
                "url": "https://agents-md-generator.fastmcp.app/mcp"
              },
              "code-search": {
                "type": "http",
                "url": "https://public-code-search.fastmcp.app/mcp"
              },
              "github-research": {
                "type": "stdio",
                "command": "uvx",
                "args": [
                  "github-research-mcp"
                ],
                "env": {
                  "DISABLE_SUMMARIES": "true",
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                }
              }
            }
          }
          EOF

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1.0.23
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          additional_permissions: |
            actions: read

          prompt: ${{ steps.triage-prompt.outputs.PROMPT }}
          track_progress: true
          claude_args: |
            --allowed-tools mcp__github-pr,mcp__repository-summary,mcp__code-search,mcp__github-research,WebSearch,WebFetch,Bash(make:*)
            --mcp-config /tmp/mcp-config/mcp-servers.json
